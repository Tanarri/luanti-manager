#!/bin/bash
set -euo pipefail

# ---------- Einstellungen ----------
LUANTI_DIR="${LUANTI_DIR:-$HOME/luanti}"
BASE_DIR="${BASE_DIR:-$HOME/luanti-manager}"
CONF_FILE="${CONF_FILE:-$BASE_DIR/luanti_instances.conf}"
RUN_DIR="$BASE_DIR/run"
LOG_DIR="$BASE_DIR/logs"

mkdir -p "$RUN_DIR" "$LOG_DIR"

# ---------- Helper ----------
die() { echo "ERROR: $*" >&2; exit 1; }
warn() { echo "WARN:  $*" >&2; }

usage() {
  cat <<'EOF'
luantictl - Luanti Multi-Instance Controller (PID-basiert)

Usage:
  luantictl start   all|<name>
  luantictl stop    all|<name>
  luantictl restart all|<name>
  luantictl status  [all|<name>]
  luantictl tail    <name> [lines]
  luantictl ports
  luantictl check
  luantictl help

Optional env vars:
  LUANTI_DIR=/path/to/luanti
  BASE_DIR=/path/to/luanti-manager
  CONF_FILE=/path/to/luanti_instances.conf

Config format:
  NAME|WORLDREL|PORT|LOGREL|GAMEID
  GAMEID may be empty.
EOF
}

need_conf() {
  [[ -f "$CONF_FILE" ]] || die "Config nicht gefunden: $CONF_FILE"
  [[ -d "$LUANTI_DIR" ]] || die "LUANTI_DIR nicht gefunden: $LUANTI_DIR"
  [[ -x "$LUANTI_DIR/bin/luanti" ]] || die "luanti binary nicht ausführbar: $LUANTI_DIR/bin/luanti"
}

# Iteriert über Config; callback bekommt 5 args: name worldrel port logrel gameid
for_each_instance() {
  local cb="$1"
  while IFS='|' read -r NAME WORLDREL PORT LOGREL GAMEID; do
    [[ -z "${NAME// /}" ]] && continue
    [[ "$NAME" =~ ^# ]] && continue

    # trim spaces (rudimentär)
    NAME="${NAME#"${NAME%%[![:space:]]*}"}"; NAME="${NAME%"${NAME##*[![:space:]]}"}"
    WORLDREL="${WORLDREL#"${WORLDREL%%[![:space:]]*}"}"; WORLDREL="${WORLDREL%"${WORLDREL##*[![:space:]]}"}"
    PORT="${PORT#"${PORT%%[![:space:]]*}"}"; PORT="${PORT%"${PORT##*[![:space:]]}"}"
    LOGREL="${LOGREL#"${LOGREL%%[![:space:]]*}"}"; LOGREL="${LOGREL%"${LOGREL##*[![:space:]]}"}"
    GAMEID="${GAMEID#"${GAMEID%%[![:space:]]*}"}"; GAMEID="${GAMEID%"${GAMEID##*[![:space:]]}"}"

    "$cb" "$NAME" "$WORLDREL" "$PORT" "$LOGREL" "$GAMEID"
  done < "$CONF_FILE"
}

get_instance_line() {
  local target="$1"
  local found=1
  while IFS='|' read -r NAME WORLDREL PORT LOGREL GAMEID; do
    [[ -z "${NAME// /}" ]] && continue
    [[ "$NAME" =~ ^# ]] && continue
    NAME="${NAME#"${NAME%%[![:space:]]*}"}"; NAME="${NAME%"${NAME##*[![:space:]]}"}"
    if [[ "$NAME" == "$target" ]]; then
      echo "$NAME|$WORLDREL|$PORT|$LOGREL|$GAMEID"
      found=0
      break
    fi
  done < "$CONF_FILE"
  return $found
}

pidfile_of() { echo "$RUN_DIR/$1.pid"; }
logfile_of_rel() { echo "$BASE_DIR/$1"; }

is_pid_running() {
  local pid="$1"
  [[ -n "${pid:-}" ]] && kill -0 "$pid" 2>/dev/null
}

port_listening() {
  local port="$1"
  command -v ss >/dev/null 2>&1 || return 2
  ss -ltn | awk '{print $4}' | grep -qE ":${port}\$"
}

start_one() {
  local NAME="$1" WORLDREL="$2" PORT="$3" LOGREL="$4" GAMEID="$5"
  local PIDFILE LOGFILE PID
  PIDFILE="$(pidfile_of "$NAME")"
  LOGFILE="$(logfile_of_rel "$LOGREL")"

  mkdir -p "$(dirname "$LOGFILE")"

  # Schon laufend?
  if [[ -f "$PIDFILE" ]]; then
    PID="$(cat "$PIDFILE" || true)"
    if is_pid_running "$PID"; then
      echo "[$NAME] läuft bereits (PID $PID)"
      return 0
    else
      rm -f "$PIDFILE"
    fi
  fi

  # Port belegt?
  if port_listening "$PORT"; then
    echo "[$NAME] Port $PORT ist bereits belegt (lauscht schon). Abbruch."
    return 2
  fi

  cd "$LUANTI_DIR" || return 1

  local CMD=(./bin/luanti --world "$WORLDREL" --server --port "$PORT")
  if [[ -n "${GAMEID:-}" ]]; then
    CMD+=(--gameid "$GAMEID")
  fi

  echo "[$NAME] start: world=$WORLDREL port=$PORT gameid=${GAMEID:-<default>} log=$LOGFILE"
  nohup "${CMD[@]}" >>"$LOGFILE" 2>&1 &
  echo $! > "$PIDFILE"
  echo "[$NAME] started (PID $(cat "$PIDFILE"))"
}

_stop_all_cb() {
  local NAME="$1"
  stop_one "$NAME"
}

stop_one() {
  local NAME="$1"
  local PIDFILE PID
  PIDFILE="$(pidfile_of "$NAME")"

  if [[ ! -f "$PIDFILE" ]]; then
    echo "[$NAME] kein PID-File (nicht gestartet?)"
    return 0
  fi

  PID="$(cat "$PIDFILE" || true)"
  if ! is_pid_running "$PID"; then
    echo "[$NAME] Prozess läuft nicht (PID=$PID). Entferne PID-File."
    rm -f "$PIDFILE"
    return 0
  fi

  echo "[$NAME] stop: PID $PID"
  kill "$PID" 2>/dev/null || true

  for _ in {1..20}; do
    if is_pid_running "$PID"; then
      sleep 0.5
    else
      rm -f "$PIDFILE"
      echo "[$NAME] stopped"
      return 0
    fi
  done

  echo "[$NAME] stop: SIGKILL PID $PID"
  kill -9 "$PID" 2>/dev/null || true
  rm -f "$PIDFILE"
  echo "[$NAME] stopped (hard)"
}

status_one() {
  local NAME="$1" WORLDREL="$2" PORT="$3" LOGREL="$4" GAMEID="$5"
  local PIDFILE PID ls
  PIDFILE="$(pidfile_of "$NAME")"
  PID=""
  [[ -f "$PIDFILE" ]] && PID="$(cat "$PIDFILE" || true)"

  local alive="no"
  if is_pid_running "$PID"; then alive="yes"; fi

  local listen="?"
  if command -v ss >/dev/null 2>&1; then
    if port_listening "$PORT"; then listen="yes"; else listen="no"; fi
  fi

  printf "[%s] pid=%s alive=%s listen=%s port=%s gameid=%s world=%s log=%s\n" \
    "$NAME" "${PID:-"-"}" "$alive" "$listen" "$PORT" "${GAMEID:-"-"}" "$WORLDREL" "$LOGREL"
}

check_conf() {
  need_conf
  local ok=0

  for_each_instance _check_line || ok=1
  return $ok
}

_check_line() {
  local NAME="$1" WORLDREL="$2" PORT="$3" LOGREL="$4" GAMEID="$5"

  [[ -n "$NAME" ]] || { warn "Leerer NAME"; return 1; }
  [[ -n "$WORLDREL" ]] || { warn "[$NAME] WORLDREL leer"; return 1; }
  [[ -n "$PORT" ]] || { warn "[$NAME] PORT leer"; return 1; }
  [[ "$PORT" =~ ^[0-9]+$ ]] || { warn "[$NAME] PORT ist keine Zahl: $PORT"; return 1; }
  (( PORT >= 1 && PORT <= 65535 )) || { warn "[$NAME] PORT außerhalb 1..65535: $PORT"; return 1; }
  [[ -n "$LOGREL" ]] || { warn "[$NAME] LOGREL leer"; return 1; }

  # world exists?
  if [[ ! -d "$LUANTI_DIR/$WORLDREL" ]]; then
    warn "[$NAME] World-Pfad existiert nicht: $LUANTI_DIR/$WORLDREL"
  fi

  return 0
}

_stop_from_name_only() {
  local NAME="$1"
  stop_one "$NAME"
}

_restart_one() {
  local NAME="$1" WORLDREL="$2" PORT="$3" LOGREL="$4" GAMEID="$5"
  stop_one "$NAME"
  sleep 1
  start_one "$NAME" "$WORLDREL" "$PORT" "$LOGREL" "$GAMEID"
}

_ports_one() {
  local NAME="$1" _WORLDREL="$2" PORT="$3" _LOGREL="$4" _GAMEID="$5"
  local listen="?"
  if command -v ss >/dev/null 2>&1; then
    if port_listening "$PORT"; then listen="LISTEN"; else listen="-"; fi
  fi
  printf "[%s] port=%s %s\n" "$NAME" "$PORT" "$listen"
}

# ---------- Commands ----------
cmd="${1:-help}"
arg="${2:-}"

need_conf_if_needed() {
  case "$cmd" in
    help|--help|-h) return 0 ;;
    *) need_conf ;;
  esac
}

need_conf_if_needed

case "$cmd" in
  help|--help|-h)
    usage
    ;;

  check)
    if check_conf; then
      echo "OK: Config sieht brauchbar aus."
    else
      echo "Config hat Probleme (siehe WARN/ERROR)."
      exit 2
    fi
    ;;

  start)
    [[ -n "$arg" ]] || die "start braucht all|<name>"
    if [[ "$arg" == "all" ]]; then
      for_each_instance start_one
    else
      line="$(get_instance_line "$arg")" || die "Unbekannte Instanz: $arg"
      IFS='|' read -r NAME WORLDREL PORT LOGREL GAMEID <<<"$line"
      start_one "$NAME" "$WORLDREL" "$PORT" "$LOGREL" "$GAMEID"
    fi
    ;;

  stop)
    [[ -n "$arg" ]] || die "stop braucht all|<name>"
    if [[ "$arg" == "all" ]]; then
      # Stop lieber in umgekehrter Reihenfolge? Hier simpel: wie Config.
      for_each_instance _stop_all_cb
    else
      stop_one "$arg"
    fi
    ;;

  restart)
    [[ -n "$arg" ]] || die "restart braucht all|<name>"
    if [[ "$arg" == "all" ]]; then
      for_each_instance _restart_one
    else
      line="$(get_instance_line "$arg")" || die "Unbekannte Instanz: $arg"
      IFS='|' read -r NAME WORLDREL PORT LOGREL GAMEID <<<"$line"
      stop_one "$NAME"
      sleep 1
      start_one "$NAME" "$WORLDREL" "$PORT" "$LOGREL" "$GAMEID"
    fi
    ;;

  status)
    if [[ -z "$arg" || "$arg" == "all" ]]; then
      for_each_instance status_one
    else
      line="$(get_instance_line "$arg")" || die "Unbekannte Instanz: $arg"
      IFS='|' read -r NAME WORLDREL PORT LOGREL GAMEID <<<"$line"
      status_one "$NAME" "$WORLDREL" "$PORT" "$LOGREL" "$GAMEID"
    fi
    ;;

  tail)
    [[ -n "$arg" ]] || die "tail braucht <name> [lines]"
    lines="${3:-100}"
    line="$(get_instance_line "$arg")" || die "Unbekannte Instanz: $arg"
    IFS='|' read -r NAME _WORLDREL _PORT LOGREL _GAMEID <<<"$line"
    LOGFILE="$(logfile_of_rel "$LOGREL")"
    [[ -f "$LOGFILE" ]] || die "Logfile nicht gefunden: $LOGFILE"
    tail -n "$lines" -f "$LOGFILE"
    ;;

  ports)
    for_each_instance _ports_one
    ;;

  *)
    die "Unbekannter Befehl: $cmd (nutze: luantictl help)"
    ;;
esac
